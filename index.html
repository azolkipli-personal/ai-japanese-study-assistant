<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenAI Japanese Study Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 1200px;
        }
        /* Custom styles for loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Updated tab button styling to match input method buttons */
        .tab-button {
            width: 100%;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-left: 1rem;
            padding-right: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-duration: 150ms;
        }
        #tab-generate-btn {
            color: #4B5563; /* text-gray-600 */
        }
        #tab-generate-btn.active {
            background-color: #fff;
            color: #2563eb; /* text-blue-600 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        #tab-review-btn {
            color: #4B5563; /* text-gray-600 */
        }
        #tab-review-btn.active {
            background-color: #fff;
            color: #8b5cf6; /* text-purple-600 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .tab-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 42rem;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Japanese Study Assistant</h1>
            <p class="mt-2 text-lg text-gray-600">Upload or enter a word list, get AI-powered conversation examples.</p>
        </header>

        <!-- Tab Navigation - now using flex and space-x to mimic input method buttons -->
        <div class="flex items-center space-x-4 p-1 bg-gray-100 rounded-lg w-full max-w-2xl mx-auto mb-4">
            <button id="tab-generate-btn" class="tab-button active">Generate</button>
            <button id="tab-review-btn" class="tab-button">Review Output</button>
        </div>

        <!-- Generate Tab Content -->
        <div id="tab-content-generate" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Configure Your Session</h2>
            
            <div class="mb-4">
                <label for="llm-select" class="block text-sm font-medium text-gray-700 mb-1">Select Language Model</label>
                <select id="llm-select" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="gemini" selected>Gemini Flash (Cloud)</option>
                    <option value="ollama">Ollama (Local)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Select 'Ollama' only if you have it running locally on your computer.</p>
            </div>

            <div id="ollama-model-container" class="mb-4" style="display: none;">
                <label for="ollama-model-select" class="block text-sm font-medium text-gray-700 mb-1">Ollama Model</label>
                <select id="ollama-model-select" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">Loading models...</option>
                </select>
                <p class="text-xs text-gray-500 mt-1" id="ollama-model-status">Please ensure Ollama server is running locally.</p>
            </div>

            <div class="mb-4">
                <label for="gemini-api-key-input" class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key (optional)</label>
                <input type="password" id="gemini-api-key-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Enter your Gemini API Key">
                <p class="text-xs text-gray-500 mt-1">If left empty, the platform's injected key (if any) will be used. Stored locally for convenience.</p>
            </div>

            <div class="mb-4">
                <label for="scenario-input" class="block text-sm font-medium text-gray-700 mb-1">Enter a Scenario (optional)</label>
                <input type="text" id="scenario-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., At a restaurant, Planning a trip, First day at work">
                <p class="text-xs text-gray-500 mt-1">Provide a context to make the examples more specific.</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Input Method</label>
                <div class="flex items-center space-x-4 p-1 bg-gray-100 rounded-lg">
                    <button id="input-method-file" class="w-full py-2 text-sm font-semibold rounded-md transition-colors bg-white text-blue-600 shadow">Upload File</button>
                    <button id="input-method-manual" class="w-full py-2 text-sm font-semibold rounded-md transition-colors text-gray-600">Manual Entry</button>
                </div>
            </div>

            <div id="file-input-container" class="mt-4">
                   <input type="file" id="file-input" accept=".txt" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                  "/>
            </div>
            
            <div id="manual-input-container" class="mt-4" style="display: none;">
                <textarea id="word-textarea" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="猫&#10;食べる&#10;学校"></textarea>
            </div>


            <div class="mt-6 space-y-4">
                   <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 disabled:bg-gray-400">
                    Generate Examples
                </button>
            </div>
        </div>

        <div id="progress-container" class="text-center my-6" style="display: none;">
                   <div class="loader mx-auto"></div>
                   <p id="progress-text" class="mt-4 text-gray-600 font-medium"></p>
        </div>

        <!-- New section for Word Details & Translations -->
        <div id="word-details-section" class="mt-10" style="display: none;">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4">2. Word Details & Translations</h2>
            <div id="word-details-container" class="space-y-4">
                <!-- Word details will be inserted here -->
            </div>
        </div>

        <div id="results-section" class="mt-10" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                   <h2 class="text-2xl md:text-3xl font-bold text-gray-900">3. Generated Examples</h2>
                   <div class="flex space-x-2">
                       <button id="export-csv-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300">
                           Export to CSV
                       </button>
                       <button id="export-json-btn" class="bg-purple-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-300">
                           Export to JSON
                       </button>
                   </div>
            </div>
            <div id="results-container" class="space-y-8">
                <!-- Generated content will be inserted here -->
            </div>
        </div>
        
        <!-- Review Output Tab Content -->
        <div id="tab-content-review" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Review Exported JSON Output</h2>
            <div class="mb-4">
                <label for="json-file-input" class="block text-sm font-medium text-gray-700 mb-1">Upload JSON File(s)</label>
                <input type="file" id="json-file-input" accept=".json" multiple class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                "/>
                <p class="text-xs text-gray-500 mt-1">Select one or more previously exported JSON files to review their contents.</p>
            </div>

            <div id="review-output-display" class="mt-6">
                <h3 class="text-xl font-semibold mb-3 text-gray-800">Loaded Data:</h3>
                <div id="review-word-details-container" class="space-y-4">
                    <!-- Reviewed word details will be inserted here -->
                </div>
                <div id="review-results-container" class="space-y-8 mt-8">
                    <!-- Reviewed examples will be inserted here -->
                </div>
                <p id="review-status-message" class="text-gray-600 mt-4">Upload a JSON file(s) to see its content here.</p>
            </div>
        </div>

        <!-- Error Message Box -->
        <div id="error-box" class="fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg" style="display: none; z-index: 100;">
            <strong class="font-bold">Error:</strong>
            <span id="error-message" class="block sm:inline"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="document.getElementById('error-box').style.display='none'">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

    </div>

    <script>
        // Get references to DOM elements
        const fileInput = document.getElementById('file-input');
        const wordTextarea = document.getElementById('word-textarea');
        const generateBtn = document.getElementById('generate-btn');
        const llmSelect = document.getElementById('llm-select');
        const ollamaModelContainer = document.getElementById('ollama-model-container'); 
        const ollamaModelSelect = document.getElementById('ollama-model-select'); 
        const ollamaModelStatus = document.getElementById('ollama-model-status'); 
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input'); 
        const scenarioInput = document.getElementById('scenario-input');
        const progressContainer = document.getElementById('progress-container');
        const progressText = document.getElementById('progress-text');
        const wordDetailsSection = document.getElementById('word-details-section'); 
        const wordDetailsContainer = document.getElementById('word-details-container'); 
        const resultsSection = document.getElementById('results-section');
        const resultsContainer = document.getElementById('results-container');
        const exportCsvBtn = document.getElementById('export-csv-btn'); 
        const exportJsonBtn = document.getElementById('export-json-btn'); 
        // const clearDataBtn = document.getElementById('clear-data-btn'); // Removed
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        const fileInputContainer = document.getElementById('file-input-container');
        const manualInputContainer = document.getElementById('manual-input-container');
        const methodFileBtn = document.getElementById('input-method-file');
        const methodManualBtn = document.getElementById('input-method-manual');
        let currentInputMethod = 'file'; 

        // Tab elements
        const tabGenerateBtn = document.getElementById('tab-generate-btn');
        const tabReviewBtn = document.getElementById('tab-review-btn');
        const tabContentGenerate = document.getElementById('tab-content-generate');
        const tabContentReview = document.getElementById('tab-content-review');

        // Review tab specific elements
        const jsonFileInput = document.getElementById('json-file-input');
        const reviewWordDetailsContainer = document.getElementById('review-word-details-container');
        const reviewResultsContainer = document.getElementById('review-results-container');
        const reviewStatusMessage = document.getElementById('review-status-message');


        let generatedData = []; // Stores the data generated by the LLM

        /**
         * Sets the input method (file upload or manual text entry) and updates UI.
         * @param {string} method - 'file' or 'manual'.
         */
        function setInputMethod(method) {
            currentInputMethod = method;
            if (method === 'file') {
                fileInputContainer.style.display = 'block';
                manualInputContainer.style.display = 'none';
                methodFileBtn.classList.add('bg-white', 'text-blue-600', 'shadow');
                methodFileBtn.classList.remove('text-gray-600');
                methodManualBtn.classList.remove('bg-white', 'text-blue-600', 'shadow');
                methodManualBtn.classList.add('text-gray-600');
            } else {
                fileInputContainer.style.display = 'none';
                manualInputContainer.style.display = 'block';
                methodManualBtn.classList.add('bg-white', 'text-blue-600', 'shadow');
                methodManualBtn.classList.remove('text-gray-600');
                methodFileBtn.classList.remove('bg-white', 'text-blue-600', 'shadow');
                methodFileBtn.classList.add('text-gray-600');
            }
        }

        // Add event listeners to buttons
        generateBtn.addEventListener('click', handleGeneration);
        exportCsvBtn.addEventListener('click', exportToCsv); 
        exportJsonBtn.addEventListener('click', exportToJson); 
        methodFileBtn.addEventListener('click', () => setInputMethod('file'));
        methodManualBtn.addEventListener('click', () => setInputMethod('manual'));
        llmSelect.addEventListener('change', toggleOllamaModelInput); 
        // clearDataBtn.addEventListener('click', clearLocalData); // Removed

        // Event listeners for saving configuration on input changes
        llmSelect.addEventListener('change', saveConfig);
        ollamaModelSelect.addEventListener('change', saveConfig);
        geminiApiKeyInput.addEventListener('input', saveConfig); 
        scenarioInput.addEventListener('input', saveConfig);

        // New event listeners for tab switching
        tabGenerateBtn.addEventListener('click', () => showTab('generate'));
        tabReviewBtn.addEventListener('click', () => showTab('review'));
        jsonFileInput.addEventListener('change', handleJsonFileLoad);

        /**
         * Shows the selected tab and hides others.
         * @param {string} tabId - The ID of the tab to show ('generate' or 'review').
         */
        function showTab(tabId) {
            // Hide all tab contents
            tabContentGenerate.style.display = 'none';
            tabContentReview.style.display = 'none';

            // Deactivate all tab buttons
            tabGenerateBtn.classList.remove('active');
            tabReviewBtn.classList.remove('active');

            // Show the selected tab content and activate its button
            if (tabId === 'generate') {
                tabContentGenerate.style.display = 'block';
                tabGenerateBtn.classList.add('active');
            } else if (tabId === 'review') {
                tabContentReview.style.display = 'block';
                tabReviewBtn.classList.add('active');
                // Clear previous review content when switching to review tab
                reviewWordDetailsContainer.innerHTML = '';
                reviewResultsContainer.innerHTML = '';
                reviewStatusMessage.textContent = 'Upload a JSON file(s) to see its content here.';
                jsonFileInput.value = ''; // Clear file input
            }
        }

        // --- Local Storage Functions ---

        /**
         * Loads configuration from localStorage and populates UI.
         */
        function loadConfig() {
            const savedLlm = localStorage.getItem('llmSelect');
            const savedOllamaModel = localStorage.getItem('ollamaModelSelect');
            const savedApiKey = localStorage.getItem('geminiApiKey');
            const savedScenario = localStorage.getItem('scenarioInput');

            if (savedLlm) {
                llmSelect.value = savedLlm;
            }
            if (savedOllamaModel) {
                ollamaModelSelect.value = savedOllamaModel;
            }
            if (savedApiKey) {
                geminiApiKeyInput.value = savedApiKey;
            }
            if (savedScenario) {
                scenarioInput.value = savedScenario;
            }
            toggleOllamaModelInput(); // Call to set initial visibility and load Ollama models
        }

        /**
         * Saves current configuration to localStorage.
         */
        function saveConfig() {
            localStorage.setItem('llmSelect', llmSelect.value);
            localStorage.setItem('ollamaModelSelect', ollamaModelSelect.value);
            localStorage.setItem('geminiApiKey', geminiApiKeyInput.value); 
            localStorage.setItem('scenarioInput', scenarioInput.value);
        }

        /**
         * Loads previously generated data from localStorage and displays it.
         */
        function loadGeneratedData() {
            const savedData = localStorage.getItem('generatedData');
            if (savedData) {
                try {
                    generatedData = JSON.parse(savedData);
                    if (generatedData.length > 0) {
                        wordDetailsSection.style.display = 'block';
                        resultsSection.style.display = 'block';
                        wordDetailsContainer.innerHTML = ''; 
                        resultsContainer.innerHTML = '';     
                        generatedData.forEach(item => displayWordDetails(item));
                        generatedData.forEach(item => displayResult(item));
                    }
                } catch (e) {
                    console.error("Error parsing saved data from localStorage:", e);
                    showError("Could not load previous data. It might be corrupted.");
                    localStorage.removeItem('generatedData'); 
                }
            }
        }

        /**
         * Saves the current generated data to localStorage.
         */
        function saveGeneratedData() {
            localStorage.setItem('generatedData', JSON.stringify(generatedData));
        }

        // Removed clearLocalData function
        // function clearLocalData() {
        //     if (confirm('Are you sure you want to clear all locally stored data and configurations? This cannot be undone.')) {
        //         localStorage.clear();
        //         generatedData = [];
        //         wordDetailsContainer.innerHTML = '';
        //         resultsContainer.innerHTML = '';
        //         wordDetailsSection.style.display = 'none';
        //         resultsSection.style.display = 'none';
        //         // Reset UI elements to default state after clearing
        //         llmSelect.value = 'gemini';
        //         ollamaModelSelect.value = '';
        //         geminiApiKeyInput.value = '';
        //         scenarioInput.value = '';
        //         toggleOllamaModelInput(); 
        //         showError('All local data has been cleared.');
        //     }
        // }


        // --- End Local Storage Functions ---

        // Initial load of configuration and data when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadGeneratedData();
            showTab('generate'); // Show the generate tab by default on load

            // Check if the file is being run directly from the file system (potential CORS issue for Ollama)
            if (window.location.protocol === 'file:') {
                console.warn(
                    "Warning: You are running this HTML file directly from your file system (file:// protocol). " +
                    "If you encounter 'Failed to fetch' errors when using Ollama, it's likely due to CORS restrictions. " +
                    "Please serve this file using a local web server (e.g., Python's `http.server`, Node.js `serve` package, or similar) " +
                    "to resolve this. For example, in your terminal, navigate to the directory containing this file and run `python -m http.server`."
                );
            }
        });


        /**
         * Fetches the list of available Ollama models from the local server.
         * @returns {Promise<Array<string>>} - An array of model names.
         */
        async function fetchOllamaModels() {
            const apiUrl = `http://localhost:11434/api/tags`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    // Attempt to parse error message from Ollama if available
                    const errorText = await response.text();
                    let specificError = `Ollama API Error: ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.error) {
                            specificError += `: ${errorJson.error}`;
                        }
                    } catch (e) {
                        // Not a JSON error, use the raw text if it's short, otherwise generic
                        specificError += `: ${errorText.substring(0, 100)}...` || '';
                    }
                    throw new Error(specificError);
                }
                const result = await response.json();
                if (result && result.models && Array.isArray(result.models)) {
                    return result.models.map(model => model.name);
                } else {
                    throw new Error("Invalid response structure for Ollama models.");
                }
            } catch (e) {
                console.error("Error fetching Ollama models:", e);
                // More specific error message for network issues related to Ollama connectivity
                if (e instanceof TypeError && e.message === 'Failed to fetch') {
                    throw new Error(
                        "Could not connect to Ollama server. Please ensure Ollama is running and accessible at " +
                        "http://localhost:11434. If you are running this HTML file directly from your file system (file:// protocol), " +
                        "you might encounter CORS issues. Please serve it via a local web server (e.g., Python's `http.server`)."
                    );
                } else {
                    throw e; // Re-throw other types of errors
                }
            }
        }

        /**
         * Populates the Ollama model select dropdown with available models.
         */
        async function populateOllamaModels() {
            ollamaModelSelect.innerHTML = '<option value="">Loading models...</option>';
            ollamaModelStatus.textContent = 'Fetching models from Ollama server...';
            ollamaModelSelect.disabled = true;

            try {
                const models = await fetchOllamaModels();
                ollamaModelSelect.innerHTML = ''; 

                if (models.length > 0) {
                    ollamaModelSelect.add(new Option('Select a model', '')); 
                    models.forEach(modelName => {
                        ollamaModelSelect.add(new Option(modelName, modelName));
                    });
                    ollamaModelStatus.textContent = ''; 
                    ollamaModelSelect.disabled = false;
                    const savedOllamaModel = localStorage.getItem('ollamaModelSelect');
                    if (savedOllamaModel && models.includes(savedOllamaModel)) {
                        ollamaModelSelect.value = savedOllamaModel;
                    }
                } else {
                    ollamaModelSelect.add(new Option('No models found', ''));
                    ollamaModelStatus.textContent = 'No Ollama models found. Please download models (e.g., "ollama pull llama3").';
                }
            } catch (error) {
                ollamaModelSelect.innerHTML = '<option value="">Error loading models</option>';
                ollamaModelStatus.textContent = error.message;
                showError(error.message);
            } finally {
                ollamaModelSelect.disabled = false; 
            }
        }

        /**
         * Toggles the visibility of the Ollama model input/select field based on LLM selection.
         */
        function toggleOllamaModelInput() {
            if (llmSelect.value === 'ollama') {
                ollamaModelContainer.style.display = 'block';
                populateOllamaModels(); 
            } else {
                ollamaModelContainer.style.display = 'none';
                ollamaModelSelect.innerHTML = '<option value="">Loading models...</option>'; 
                ollamaModelStatus.textContent = 'Please ensure Ollama server is running locally.';
            }
        }

        /**
         * Handles the generation process, reading input, calling LLMs, and displaying results.
         */
        async function handleGeneration() {
            const scenario = scenarioInput.value.trim();
            let words = [];
            let content = '';
            const selectedLLM = llmSelect.value; 
            const ollamaModel = ollamaModelSelect.value; 

            saveConfig();

            try {
                if (currentInputMethod === 'file') {
                    if (!fileInput.files[0]) {
                        showError('Please select a file first.');
                        return;
                    }
                    content = await fileInput.files[0].text();
                } else {
                    content = wordTextarea.value;
                }
                
                words = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);

                if (words.length === 0) {
                    showError('No words provided. Please upload a file or enter words manually.');
                    return;
                }

                if (selectedLLM === 'ollama' && !ollamaModel) {
                    showError('Please select an Ollama model from the dropdown.');
                    return;
                }

            } catch(e) {
                showError('Could not read the input. Please check the file or manual entry.');
                console.error(e);
                return;
            }

            disableUI(true);
            progressContainer.style.display = 'block';
            wordDetailsSection.style.display = 'none'; 
            wordDetailsContainer.innerHTML = ''; 
            resultsSection.style.display = 'none';
            resultsContainer.innerHTML = ''; 
            generatedData = []; 

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                try {
                    progressText.textContent = `Getting details for "${word}" (${i + 1} of ${words.length})...`;
                    const details = await getWordDetails(word, selectedLLM, ollamaModel);

                    progressText.textContent = `Generating examples for "${word}" (${i + 1} of ${words.length})...`;
                    const examples = await getAIExamples(word, scenario, selectedLLM, ollamaModel);

                    if (details && examples) {
                        generatedData.push({ word, details, examples });
                    }
                } catch (error) {
                    console.error(`Error processing word "${word}":`, error);
                    // Critical network error for Ollama should stop the process
                    if (selectedLLM === 'ollama' && error.message.includes('Could not connect to Ollama')) {
                        showError(error.message); // Show the specific connection error
                        break; // Stop processing further words if Ollama connection is down
                    } else {
                        // For other errors (e.g., malformed JSON from Ollama, or Gemini errors), skip this word and continue
                        showError(`Failed to process "${word}". Skipping. Error: ${error.message}`);
                    }
                }
            }
            
            progressContainer.style.display = 'none';
            if(generatedData.length > 0) {
                wordDetailsSection.style.display = 'block';
                generatedData.forEach(item => displayWordDetails(item));
                
                resultsSection.style.display = 'block';
                generatedData.forEach(item => displayResult(item)); 
                saveGeneratedData(); 
            }
            disableUI(false); 
        }
        
        /**
         * Calls the LLM to get hiragana/katakana reading, English translation, and a brief description for a Japanese word.
         * @param {string} word - The Japanese word.
         * @param {string} selectedLLM - The currently selected LLM ('gemini' or 'ollama').
         * @param {string} [ollamaModel] - The Ollama model name (optional, only for Ollama).
         * @returns {Promise<Object>} - An object with 'kana', 'translation', and 'description' properties.
         */
        async function getWordDetails(word, selectedLLM, ollamaModel) {
            const prompt = `For the Japanese word "${word}", provide its hiragana or katakana reading, a concise English translation, and a very brief English description (1-2 sentences, e.g., "common verb", "noun for animal", "describes a state"). Return the result as a single, minified JSON object with keys "kana", "translation", and "description". Example: for "猫", return {"kana":"ねこ","translation":"Cat", "description":"Common noun for a domestic animal."}.`;
            
            if (selectedLLM === 'gemini') {
                const schema = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "kana": { "type": "STRING" },
                            "translation": { "type": "STRING" },
                            "description": { "type": "STRING" }
                        },
                        required: ["kana", "translation", "description"]
                    }
                };
                return callGeminiAPI(prompt, schema);
            } else { // ollama
                const ollamaResponse = await callOllamaAPI(prompt, ollamaModel); 
                try {
                    const cleanedResponse = ollamaResponse.replace(/```json\n?|\n?```/g, '').trim();
                    return JSON.parse(cleanedResponse);
                } catch (e) {
                    throw new SyntaxError(`SyntaxError: Expected ',' or ']' after array element in JSON. Raw response: "${ollamaResponse.substring(0, 200)}..."`);
                }
            }
        }

        /**
         * Calls the LLM to generate conversation examples for a Japanese word.
         * @param {string} word - The Japanese word.
         * @param {string} scenario - Optional scenario for context.
         * @param {string} selectedLLM - The currently selected LLM ('gemini' or 'ollama').
         * @param {string} [ollamaModel] - The Ollama model name (optional, only for Ollama).
         * @returns {Promise<Array<Object>>} - An array of conversation example objects.
         */
        async function getAIExamples(word, scenario, selectedLLM, ollamaModel) {
            let prompt = `You are an expert Japanese language tutor. For the given Japanese word, create exactly 5 natural, distinct, and simple conversation examples between two people, A and B.`;
            
            if (scenario) {
                prompt += ` The conversations MUST be related to the following scenario: "${scenario}".`;
            }

            prompt += `

For each example, provide three fields:
1. "japanese": The conversation between A and B in Japanese characters (Kanji, Hiragana, Katakana). Use "A:" and "B:" to label the speakers, placing each speaker's line on a new line (using a '\\n' character).
2. "romaji": The Hepburn-style romaji transliteration of the conversation. Use "A:" and "B:" to label the speakers, placing each speaker's line on a new line (using a '\\n' character).
3. "translation": The English translation of the conversation. Use "A:" and "B:" to label the speakers, placing each speaker's line on a new line (using a '\\n' character).

The word to use is: "${word}"

Provide the output as a single, minified JSON object containing ONLY a key "examples" which is a list of the 5 conversation example objects. Do not include any text, markdown formatting, or anything outside of this single JSON object.`;
            
            if (selectedLLM === 'gemini') {
                const schema = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT", properties: { "examples": { type: "ARRAY", items: { type: "OBJECT", properties: {
                            "japanese": { "type": "STRING" }, "romaji": { "type": "STRING" }, "translation": { "type": "STRING" }
                        }, required: ["japanese", "romaji", "translation"]}}},
                    }
                };
                const result = await callGeminiAPI(prompt, schema);
                return result.examples || [];
            } else { // ollama
                const ollamaResponse = await callOllamaAPI(prompt, ollamaModel); 
                try {
                    const cleanedResponse = ollamaResponse.replace(/```json\n?|\n?```/g, '').trim();
                    return JSON.parse(cleanedResponse).examples || [];
                } catch (e) {
                    throw new SyntaxError(`SyntaxError: Expected ',' or ']' after array element in JSON. Raw response: "${ollamaResponse.substring(0, 200)}..."`);
                }
            }
        }

        /**
         * Makes a fetch call to the Gemini API.
         * @param {string} prompt - The text prompt for the LLM.
         * @param {Object} generationConfig - Configuration for the LLM generation, including schema.
         * @returns {Promise<Object>} - Parsed JSON response from the Gemini API.
         */
        async function callGeminiAPI(prompt, generationConfig) {
            // Use the API key from the input field (if provided), otherwise fallback to default empty string
            const apiKey = geminiApiKeyInput.value.trim() || ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: generationConfig
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`Gemini API Error: ${response.status} ${errorBody}`);
            }
            const result = await response.json();
            // Check for the expected response structure and parse the text content
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } else {
                throw new Error("Invalid response structure or no content from Gemini API.");
            }
        }

        /**
         * Makes a fetch call to the local Ollama API.
         * @param {string} prompt - The text prompt for the LLM.
         * @param {string} modelName - The specific Ollama model name to use.
         * @returns {Promise<string>} - The raw text response from the Ollama API.
         */
        async function callOllamaAPI(prompt, modelName) {
            const apiUrl = `http://localhost:11434/api/generate`;
            const payload = {
                model: modelName, 
                prompt: prompt,
                format: "json", 
                stream: false 
            };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Ollama API Error: ${response.status}. Please check if Ollama is running and accessible.`);
                }
                const result = await response.json();
                return result.response; 
            } catch(e) {
                throw new Error("Could not connect to Ollama. Please ensure it is running on http://localhost:11434.");
            }
        }

        /**
         * Displays the generated word details (kana, translation, description) in the new section.
         * @param {Object} data - Contains word, details (kana, translation, description), and examples.
         * @param {HTMLElement} [targetContainer=wordDetailsContainer] - The container to append the details to.
         */
        function displayWordDetails({ word, details }, targetContainer = wordDetailsContainer) {
            const detailCard = document.createElement('div');
            detailCard.className = 'bg-white p-6 rounded-xl shadow-md';
            detailCard.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 inline">「${word}」</h3>
                <span class="ml-3 text-lg text-gray-600">${details.kana || ''}</span>
                <span class="ml-3 text-lg text-gray-500 font-medium italic">(${details.translation || ''})</span>
                <p class="mt-2 text-gray-700">${details.description || 'No description available.'}</p>
            `;
            targetContainer.appendChild(detailCard);
        }

        /**
         * Displays the generated conversation examples for a word on the page.
         * @param {Object} data - Contains word, details (kana, translation), and examples.
         * @param {HTMLElement} [targetContainer=resultsContainer] - The container to append the results to.
         */
        function displayResult({ word, details, examples }, targetContainer = resultsContainer) {
            if (!examples || examples.length === 0) return; 

            const wordContainer = document.createElement('div');
            wordContainer.className = 'bg-white p-6 rounded-xl shadow-md';
            
            let tableHTML = `
                <div class="mb-4">
                    <h3 class="text-2xl font-bold text-gray-800 inline">「${word}」</h3>
                    <span class="ml-3 text-lg text-gray-600">${details.kana}</span>
                    <span class="ml-3 text-lg text-gray-500 font-medium italic">(${details.translation})</span>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Japanese</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Romaji</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Translation</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            examples.forEach(ex => {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-pre-line text-sm font-medium text-gray-900">${ex.japanese || ''}</td>
                        <td class="px-6 py-4 whitespace-pre-line text-sm text-gray-500">${ex.romaji || ''}</td>
                        <td class="px-6 py-4 whitespace-pre-line text-sm text-gray-500">${ex.translation || ''}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table></div>`;
            wordContainer.innerHTML = tableHTML;
            targetContainer.appendChild(wordContainer); 
        }

        /**
         * Helper function to generate a timestamp for filenames.
         * @returns {string} - A timestamp string ingetFullYear()MMDDHHMM format.
         */
        function generateTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${year}${month}${day}${hours}${minutes}`;
        }

        /**
         * Exports the generated data to a CSV file.
         */
        function exportToCsv() {
            if (generatedData.length === 0) {
                showError('No data to export.');
                return;
            }

            const headers = ['Source Word', 'Kana', 'Word Translation', 'Word Description', 'Conversation Japanese', 'Conversation Romaji', 'Conversation Translation'];
            let rows = [];

            generatedData.forEach(({ word, details, examples }) => {
                examples.forEach(ex => {
                    const row = [
                        word,
                        details.kana,
                        details.translation,
                        `"${(details.description || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`, 
                        `"${(ex.japanese || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                        `"${(ex.romaji || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                        `"${(ex.translation || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`
                    ];
                    rows.push(row.join(','));
                });
            });

            const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n' + rows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');

            const filename = `${generateTimestamp()}-Output.csv`;

            link.setAttribute('href', encodedUri);
            link.setAttribute('download', filename); 
            document.body.appendChild(link);
            link.click(); 
            document.body.removeChild(link); 
        }

        /**
         * Exports the generated data to a JSON file.
         */
        function exportToJson() {
            if (generatedData.length === 0) {
                showError('No data to export.');
                return;
            }

            const jsonString = JSON.stringify(generatedData, null, 2); // Pretty-print JSON with 2-space indentation
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            const filename = `${generateTimestamp()}-Output.json`; // Dynamic filename for JSON

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up the object URL
        }

        /**
         * Handles the loading and parsing of an uploaded JSON file.
         * @param {Event} event - The file input change event.
         */
        async function handleJsonFileLoad(event) {
            const files = event.target.files;
            if (files.length === 0) {
                reviewStatusMessage.textContent = 'No file(s) selected.';
                return;
            }

            reviewStatusMessage.textContent = `Loading and parsing ${files.length} JSON file(s)...`;
            reviewWordDetailsContainer.innerHTML = ''; // Clear previous content
            reviewResultsContainer.innerHTML = '';     // Clear previous content

            let combinedLoadedData = [];
            let successfulFiles = 0;
            let failedFiles = 0;

            for (const file of files) {
                await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const loadedData = JSON.parse(e.target.result);
                            if (Array.isArray(loadedData) && loadedData.every(item => item.word && item.details && item.examples)) {
                                combinedLoadedData = combinedLoadedData.concat(loadedData);
                                successfulFiles++;
                            } else {
                                throw new Error(`Invalid JSON structure in ${file.name}. Expected an array of word entries with "word", "details", and "examples" properties.`);
                            }
                        } catch (error) {
                            console.error(`Error processing JSON file ${file.name}:`, error);
                            showError(`Error loading ${file.name}: ${error.message}`);
                            failedFiles++;
                        } finally {
                            resolve();
                        }
                    };
                    reader.onerror = () => {
                        console.error(`Failed to read file: ${file.name}`);
                        showError(`Failed to read file: ${file.name}`);
                        failedFiles++;
                        resolve();
                    };
                    reader.readAsText(file);
                });
            }

            if (combinedLoadedData.length > 0) {
                combinedLoadedData.forEach(item => displayWordDetails(item, reviewWordDetailsContainer));
                combinedLoadedData.forEach(item => displayResult(item, reviewResultsContainer));
                reviewStatusMessage.textContent = `Successfully loaded data from ${successfulFiles} file(s). ${failedFiles > 0 ? `(${failedFiles} file(s) failed to load)` : ''}`;
            } else {
                reviewStatusMessage.textContent = `No valid data loaded. ${failedFiles > 0 ? `(${failedFiles} file(s) failed to load)` : ''}`;
            }
        }


        /**
         * Disables or enables UI elements during processing.
         * @param {boolean} isDisabling - True to disable, false to enable.
         */
        function disableUI(isDisabling) {
            generateBtn.disabled = isDisabling;
            fileInput.disabled = isDisabling;
            wordTextarea.disabled = isDisabling;
            llmSelect.disabled = isDisabling;
            ollamaModelSelect.disabled = isDisabling; 
            geminiApiKeyInput.disabled = isDisabling; 
            scenarioInput.disabled = isDisabling;
            methodFileBtn.disabled = isDisabling;
            methodManualBtn.disabled = isDisabling;
            // clearDataBtn.disabled = isDisabling; // Removed
            exportCsvBtn.disabled = isDisabling; 
            exportJsonBtn.disabled = isDisabling; 
            jsonFileInput.disabled = isDisabling; 
            tabGenerateBtn.disabled = isDisabling; 
            tabReviewBtn.disabled = isDisabling;   
        }
        
        /**
         * Displays a transient error message box.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.style.display = 'block';
            setTimeout(() => {
                errorBox.style.display = 'none';
            }, 6000); 
        }

    </script>
</body>
</html>
